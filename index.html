<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RenoBoard — Renovation Hub</title>
<meta name="description" content="A calm, visual renovation hub with private data.">
<link rel="icon" href="data:,">
<style>
  :root{
    /* light, readable, WCAG-friendly */
    --bg:#f7fafc; --text:#111827; --muted:#e5e7eb; --panel:#ffffff; --soft:#4b5563;
    --brand:#2563eb; --brand-2:#22c55e; --warn:#b45309; --danger:#b91c1c;
    --card:#ffffff; --shadow:0 10px 25px rgba(0,0,0,.07); --radius:14px;
    --btn:#111827; --btn-text:#ffffff; --btn-alt:#2563eb; --btn-alt-text:#ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b0c0f; --text:#f3f4f6; --muted:#1f2937; --panel:#121418; --soft:#cbd5e1;
      --card:#0f1115; --shadow:0 10px 30px rgba(0,0,0,.35);
      --btn:#e5e7eb; --btn-text:#111827; --btn-alt:#3b82f6; --btn-alt-text:#0b0c0f;
    }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:28px auto 80px;padding:0 16px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:40px;height:40px;border-radius:12px;background:
    radial-gradient(70% 70% at 30% 20%, #60a5fa, transparent 60%),
    radial-gradient(70% 70% at 85% 75%, #34d399, transparent 60%),
    linear-gradient(135deg, #e5e7eb, #c7d2fe)}
  .title{font-weight:800;letter-spacing:.2px}
  .small{font-size:12px;color:var(--soft)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{border:1px solid var(--muted);background:var(--panel);padding:12px 16px;border-radius:12px;cursor:pointer}
  .tab.active{outline:3px solid color-mix(in srgb, var(--brand) 30%, transparent)}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0}
  input[type="text"],select,input[type="date"]{
    border:1px solid var(--muted);background:var(--panel);color:var(--text);
    padding:12px 14px;border-radius:12px;min-width:220px
  }
  .btn{background:var(--btn);color:var(--btn-text);border:none;padding:12px 18px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:var(--shadow)}
  .btn.alt{background:var(--btn-alt);color:var(--btn-alt-text)}
  .btn.ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
  .btn.warn{background:#f59e0b;color:#111}
  .btn.danger{background:#ef4444;color:#fff}
  .panel{background:var(--panel);border:1px solid var(--muted);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;gap:14px}
  .columns{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media (max-width:900px){.columns{grid-template-columns:1fr}}
  .col{display:flex;flex-direction:column;gap:10px}
  .column-header{display:flex;align-items:center;justify-content:space-between}
  .kanban{min-height:200px;display:flex;flex-direction:column;gap:10px;padding:6px}
  .drop{border:2px dashed var(--muted);border-radius:12px;padding:8px}
  .card{background:var(--card);border:1px solid var(--muted);border-radius:12px;padding:12px;display:grid;gap:8px;box-shadow:var(--shadow)}
  .rows{display:grid;gap:10px}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe}
  .tag.amber{background:#fff7ed;border-color:#fed7aa}
  .tag.red{background:#fee2e2;border-color:#fecaca}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th,td{padding:10px 12px;text-align:left}
  tbody tr{background:var(--card);border:1px solid var(--muted)}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .progress{height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:linear-gradient(90deg,#2563eb,#22c55e)}
  .right{justify-content:flex-end}
  .spacer{flex:1}
  /* Login screen */
  .login{max-width:560px;margin:10vh auto;background:var(--panel);padding:24px;border-radius:16px;border:1px solid var(--muted);box-shadow:var(--shadow)}
  .login h1{margin:0 0 8px}
  .stack{display:grid;gap:12px}
</style>
</head>
<body>
<div id="login" class="login" hidden>
  <h1>Welcome to RenoBoard</h1>
  <p class="small">Create a passphrase (or enter your existing one) to unlock your data. Your passphrase never leaves this device. Data is encrypted with AES-GCM.</p>
  <div class="stack">
    <input id="passphrase" type="text" placeholder="Passphrase (keep it memorable)">
    <div class="row">
      <div class="stack">
        <input id="gh-token" type="text" placeholder="(Optional) GitHub token with gist scope">
        <input id="gh-gist"  type="text" placeholder="(Optional) Gist ID for sync">
        <div class="small">Tip: leave Gist ID empty and click “Create Gist” later to make a private one.</div>
      </div>
      <div>
        <button class="btn ghost" id="btn-load-gist">Load from Gist</button>
      </div>
    </div>
    <div class="row">
      <div class="stack">
        <input id="import-file" type="file" accept="application/json">
        <div class="small">Or choose a previously exported encrypted backup file.</div>
      </div>
      <div><button class="btn alt" id="btn-enter">Enter</button></div>
    </div>
  </div>
</div>

<div class="wrap" id="app" hidden>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">RenoBoard</div>
        <div class="small">A calm space for the whole renovation</div>
      </div>
    </div>
    <nav class="tabs" id="tabs">
      <button class="tab active" data-tab="board">Board</button>
      <button class="tab" data-tab="contractors">Contractors</button>
      <button class="tab" data-tab="hoa">HOA</button>
      <button class="tab" data-tab="budget">Budget</button>
      <button class="tab" data-tab="wins">Wins</button>
      <button class="tab" data-tab="settings">Settings</button>
    </nav>
  </header>

  <div class="toolbar">
    <input type="text" id="q" placeholder="Search tasks…">
    <select id="f-room"><option value="">All rooms</option><option>Living Room</option><option>Kitchen</option><option>Bathroom</option><option>Bedroom</option><option>Hallway</option><option>Balcony</option></select>
    <select id="f-prio"><option value="">All priorities</option><option>High</option><option>Medium</option><option>Low</option></select>
    <div class="spacer"></div>
    <button class="btn alt" id="add-task">+ Task</button>
  </div>

  <section id="view-board" class="grid">
    <div class="panel">
      <div class="row">
        <div><strong>Progress</strong><div class="small">Auto-calculated from “Done”</div></div>
        <div class="right">
          <button class="btn ghost" id="seed">Load samples</button>
          <button class="btn ghost" id="export">Export (encrypted)</button>
          <button class="btn ghost" id="export-plain">Export (plain JSON)</button>
        </div>
      </div>
      <div class="progress"><div id="bar" style="width:0%"></div></div>
    </div>

    <div class="columns">
      <div class="col">
        <div class="column-header"><h3>Backlog</h3><button class="btn ghost" data-add="Backlog">+ Add</button></div>
        <div class="kanban drop" id="Backlog"></div>
      </div>
      <div class="col">
        <div class="column-header"><h3>Doing</h3><button class="btn ghost" data-add="Doing">+ Add</button></div>
        <div class="kanban drop" id="Doing"></div>
      </div>
      <div class="col">
        <div class="column-header"><h3>Done</h3><button class="btn ghost" data-add="Done">+ Add</button></div>
        <div class="kanban drop" id="Done"></div>
      </div>
    </div>
  </section>

  <section id="view-contractors" class="panel" hidden>
    <div class="row"><h3>Contractors</h3><div class="right"><button class="btn alt" id="add-contractor">+ Contractor</button></div></div>
    <table><thead><tr><th>Name</th><th>Trade</th><th>Phone</th><th>Notes</th><th>Rating</th><th></th></tr></thead><tbody id="ctr"></tbody></table>
  </section>

  <section id="view-hoa" class="panel" hidden>
    <div class="row"><h3>HOA & Approvals</h3><div class="right"><button class="btn alt" id="add-hoa">+ HOA Item</button></div></div>
    <div class="rows" id="hoa"></div>
  </section>

  <section id="view-budget" class="panel" hidden>
    <div class="row"><h3>Budget</h3><div class="right"><button class="btn alt" id="add-budget">+ Line</button></div></div>
    <table><thead><tr><th>Item</th><th>Category</th><th>Planned</th><th>Actual</th><th>Notes</th><th></th></tr></thead><tbody id="bdg"></tbody></table>
    <div class="row right">
      <span class="tag">Planned £<span id="sumP">0</span></span>
      <span class="tag">Actual £<span id="sumA">0</span></span>
      <span class="tag amber" id="variance">Variance £0</span>
    </div>
  </section>

  <section id="view-wins" class="panel" hidden>
    <div class="row"><h3>Wins</h3><div class="small">Capture little victories ✨</div></div>
    <div class="rows" id="wins"></div>
    <div class="row"><input id="wintext" type="text" placeholder="E.g., booked electrician, HOA form submitted…"><button class="btn alt" id="add-win">Add Win</button></div>
  </section>

  <section id="view-settings" class="panel" hidden>
    <h3>Settings & Sync</h3>
    <div class="rows">
      <div class="row">
        <div><strong>GitHub Sync</strong><div class="small">Encrypted before upload. Token stored only in this browser.</div></div>
        <div class="right">
          <button class="btn ghost" id="gist-create">Create Gist</button>
          <button class="btn ghost" id="gist-load">Load</button>
          <button class="btn alt"   id="gist-save">Save</button>
        </div>
      </div>
      <div class="row">
        <div><strong>Session</strong><div class="small">Change passphrase or lock the app.</div></div>
        <div class="right">
          <button class="btn ghost" id="change-pass">Change passphrase</button>
          <button class="btn danger" id="lock">Lock</button>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------- UX helpers ---------- */
const $ = (s, el=document)=>el.querySelector(s);
const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
const fmt = n => '£'+(Number(n||0)).toFixed(2);
const KEY = 'renoboard:encrypted:v1';          // encrypted blob
const SALT_KEY = 'renoboard:salt';             // PBKDF2 salt
const META_KEY = 'renoboard:meta';             // {gistId?, iv?}

/* ---------- Minimal data shape ---------- */
const blank = ()=>({
  tasks:[], contractors:[], hoa:[], budget:[], wins:[]
});

/* ---------- Simple tabs ---------- */
$$('.tab').forEach(b=>b.onclick=()=>{
  $$('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  $$('[id^="view-"]').forEach(s=>s.hidden=true);
  $('#view-'+b.dataset.tab).hidden=false;
});

/* ---------- Encryption (AES-GCM, PBKDF2) ---------- */
async function deriveKey(pass, salt){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:150000, hash:'SHA-256'},
    baseKey,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
}
async function encryptData(pass, data){
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const key = await deriveKey(pass, salt);
  const iv  = crypto.getRandomValues(new Uint8Array(12));
  const ct  = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(JSON.stringify(data)));
  return {salt: b64(salt), iv: b64(iv), ct: b64(new Uint8Array(ct))};
}
async function decryptData(pass, payload){
  const dec = new TextDecoder();
  const salt = b64d(payload.salt); const iv = b64d(payload.iv); const ct=b64d(payload.ct);
  const key = await deriveKey(pass, salt);
  const pt  = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct).catch(()=>null);
  if(!pt) throw new Error('Bad passphrase or data');
  return JSON.parse(dec.decode(pt));
}
const b64 = arr => btoa(String.fromCharCode(...arr));
const b64d = str => new Uint8Array([...atob(str)].map(c=>c.charCodeAt(0)));

/* ---------- Local & session ---------- */
let db = blank();
let PASS = '';   // passphrase in memory (session only)
let GIST = localStorage.getItem('renoboard:gist') || '';
let TOKEN = localStorage.getItem('renoboard:token') || '';

function saveLocal(){
  if(!PASS){ console.warn('Not saving (no passphrase)'); return; }
  encryptData(PASS, db).then(payload=>{
    localStorage.setItem(KEY, JSON.stringify(payload));
    localStorage.setItem(META_KEY, JSON.stringify({gistId:GIST}));
  });
}
async function loadLocal(pass){
  const raw = localStorage.getItem(KEY);
  if(!raw){ db = blank(); return; }
  const payload = JSON.parse(raw);
  db = await decryptData(pass, payload);
}

/* ---------- GitHub Gist sync ---------- */
async function gistCreate(){
  if(!TOKEN) return alert('Add your GitHub token first (gist scope).');
  const res = await fetch('https://api.github.com/gists',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN,'Accept':'application/vnd.github+json'},
    body: JSON.stringify({description:'RenoBoard data (encrypted)', public:false, files:{'renoboard.enc.json':{content:localStorage.getItem(KEY)||'{}'}})
  });
  if(!res.ok) return alert('Create failed: '+res.status);
  const j=await res.json(); GIST=j.id; localStorage.setItem('renoboard:gist',GIST);
  alert('Created private Gist.\nID: '+GIST);
}
async function gistSave(){
  if(!TOKEN||!GIST) return alert('Token & Gist ID required.');
  const res = await fetch('https://api.github.com/gists/'+GIST,{
    method:'PATCH',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN,'Accept':'application/vnd.github+json'},
    body: JSON.stringify({files:{'renoboard.enc.json':{content:localStorage.getItem(KEY)||'{}'}}})
  });
  if(!res.ok) return alert('Save failed: '+res.status);
  alert('Saved to Gist.');
}
async function gistLoad(){
  if(!TOKEN||!GIST) return alert('Token & Gist ID required.');
  const res = await fetch('https://api.github.com/gists/'+GIST, {headers:{'Authorization':'Bearer '+TOKEN,'Accept':'application/vnd.github+json'}});
  if(!res.ok) return alert('Load failed: '+res.status);
  const j=await res.json(); const f=j.files['renoboard.enc.json']||Object.values(j.files)[0];
  const content = await (await fetch(f.raw_url)).text();
  localStorage.setItem(KEY, content);
  alert('Downloaded. Enter your passphrase to unlock.');
}

/* ---------- UI wiring (login) ---------- */
function showLogin(show=true){ $('#login').hidden=!show; $('#app').hidden=show; }
showLogin(true);

$('#btn-enter').onclick = async ()=>{
  const pass = $('#passphrase').value.trim(); if(!pass) return alert('Please enter a passphrase.');
  try{
    PASS = pass; await loadLocal(PASS); // ok if none present
    // cache token/gist if provided
    TOKEN = $('#gh-token').value.trim() || TOKEN; GIST = $('#gh-gist').value.trim() || GIST;
    localStorage.setItem('renoboard:token', TOKEN); localStorage.setItem('renoboard:gist', GIST);
    showLogin(false); renderAll(); saveLocal();
  }catch(e){ alert('Could not unlock: '+e.message); }
};
$('#btn-load-gist').onclick = async ()=>{
  TOKEN = $('#gh-token').value.trim(); GIST = $('#gh-gist').value.trim();
  localStorage.setItem('renoboard:token', TOKEN); localStorage.setItem('renoboard:gist', GIST);
  await gistLoad();
};
$('#import-file').onchange = async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const text = await file.text();
  localStorage.setItem(KEY, text);
  alert('Imported encrypted backup. Enter your passphrase and press Enter.');
};

/* ---------- Board & features ---------- */
const columns=['Backlog','Doing','Done'];
function card(t){
  const el=document.createElement('div'); el.className='card'; el.draggable=true; el.dataset.id=t.id;
  el.innerHTML = `
    <div class="row">
      <div><strong>${esc(t.title||'Untitled')}</strong></div>
      <div>
        ${t.priority?`<span class="tag ${t.priority==='High'?'red':t.priority==='Medium'?'amber':''}">${t.priority}</span>`:''}
        ${t.room?`<span class="tag">${esc(t.room)}</span>`:''}
        ${t.due?`<span class="tag amber">Due ${t.due}</span>`:''}
        <button class="btn ghost" data-edit>Edit</button>
        <button class="btn danger" data-del>Delete</button>
      </div>
    </div>
    ${t.notes?`<div class="small">${esc(t.notes)}</div>`:''}
  `;
  el.addEventListener('dragstart',e=>{ e.dataTransfer.setData('text/plain',t.id); el.style.opacity=.6; });
  el.addEventListener('dragend',()=> el.style.opacity=1);
  el.querySelector('[data-edit]').onclick=()=> editTask(t.id);
  el.querySelector('[data-del]').onclick=()=>{ db.tasks=db.tasks.filter(x=>x.id!==t.id); saveLocal(); renderBoard(); };
  return el;
}
function renderBoard(){
  const q=$('#q').value.toLowerCase(); const r=$('#f-room').value; const p=$('#f-prio').value;
  columns.forEach(c=>{
    const colEl = $('#'+c); colEl.innerHTML='';
    colEl.ondragover = e=> e.preventDefault();
    colEl.ondrop = e=>{
      e.preventDefault();
      const id=e.dataTransfer.getData('text/plain');
      const t=db.tasks.find(x=>x.id===id); if(!t) return;
      t.status=c; saveLocal(); renderBoard();
    };
    db.tasks.filter(t=>{
      if(t.status!==c) return false;
      if(q && !(t.title?.toLowerCase().includes(q)||t.notes?.toLowerCase().includes(q))) return false;
      if(r && t.room!==r) return false;
      if(p && t.priority!==p) return false;
      return true;
    }).forEach(t=> colEl.appendChild(card(t)));
  });
  const total = db.tasks.length||1; const done = db.tasks.filter(t=>t.status==='Done').length;
  $('#bar').style.width = Math.round(done*100/total)+'%';
}
function id(){ return Math.random().toString(36).slice(2,9); }
function editTask(tid){
  const t=db.tasks.find(x=>x.id===tid)||{id:id(),status:'Backlog'};
  const title = prompt('Task title:', t.title||''); if(title===null) return;
  const room  = prompt('Room:', t.room||'') || '';
  const prio  = prompt('Priority (High/Medium/Low):', t.priority||'') || '';
  const due   = prompt('Due (YYYY-MM-DD):', t.due||'') || '';
  const notes = prompt('Notes:', t.notes||'') || '';
  Object.assign(t,{title: title.trim(), room, priority: prio, due, notes});
  if(!db.tasks.some(x=>x.id===t.id)) db.tasks.push(t);
  saveLocal(); renderBoard();
}
$('#add-task').onclick=()=> editTask(id());
$$('[data-add]').forEach(b=> b.onclick=()=>{ const tid=id(); db.tasks.push({id:tid,status:b.dataset.add,title:''}); saveLocal(); editTask(tid); });

/* Contractors */
function renderContractors(){
  const tb=$('#ctr'); tb.innerHTML='';
  db.contractors.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${esc(c.name||'')}</td><td>${esc(c.trade||'')}</td><td>${esc(c.phone||'')}</td><td>${esc(c.notes||'')}</td><td>${'★'.repeat(c.rating||0)}${'☆'.repeat(5-(c.rating||0))}</td><td class="right"><button class="btn ghost" data-e>Edit</button> <button class="btn danger" data-d>Delete</button></td>`;
    tr.querySelector('[data-e]').onclick=()=> editContractor(c.id);
    tr.querySelector('[data-d]').onclick=()=>{ db.contractors=db.contractors.filter(x=>x.id!==c.id); saveLocal(); renderContractors(); };
    tb.appendChild(tr);
  });
}
$('#add-contractor').onclick=()=> editContractor(id());
function editContractor(cid){
  const c=db.contractors.find(x=>x.id===cid)||{id:id(),rating:0};
  const name=prompt('Name:',c.name||''); if(name===null) return;
  const trade=prompt('Trade:',c.trade||'')||'';
  const phone=prompt('Phone:',c.phone||'')||'';
  const notes=prompt('Notes:',c.notes||'')||'';
  const rating=Number(prompt('Rating 0-5:',c.rating??'')||0)||0;
  Object.assign(c,{name,trade,phone,notes,rating});
  if(!db.contractors.some(x=>x.id===c.id)) db.contractors.push(c);
  saveLocal(); renderContractors();
}

/* HOA */
function renderHOA(){
  const list=$('#hoa'); list.innerHTML='';
  db.hoa.forEach(h=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `<div class="row"><div><strong>${esc(h.title||'')}</strong></div><div><span class="tag amber">${h.due?('Due '+h.due):'No date'}</span> <button class="btn ghost" data-e>Edit</button> <button class="btn danger" data-d>Delete</button></div></div>${h.desc?`<div class="small">${esc(h.desc)}</div>`:''}${h.link?`<div class="small">Doc: <a href="${esc(h.link)}" target="_blank" rel="noopener">open</a></div>`:''}<label class="small"><input type="checkbox" ${h.done?'checked':''} data-done> Done</label>`;
    card.querySelector('[data-e]').onclick=()=> editHOA(h.id);
    card.querySelector('[data-d]').onclick=()=>{ db.hoa=db.hoa.filter(x=>x.id!==h.id); saveLocal(); renderHOA(); };
    card.querySelector('[data-done]').onchange=e=>{ h.done=e.target.checked; saveLocal(); };
    list.appendChild(card);
  });
}
$('#add-hoa').onclick=()=> editHOA(id());
function editHOA(hid){
  const h=db.hoa.find(x=>x.id===hid)||{id:id(),done:false};
  const title=prompt('HOA item:',h.title||''); if(title===null) return;
  const desc =prompt('Details:',h.desc||'')||'';
  const due  =prompt('Due (YYYY-MM-DD):',h.due||'')||'';
  const contact=prompt('Contact:',h.contact||'')||'';
  const link =prompt('Doc link (optional):',h.link||'')||'';
  Object.assign(h,{title,desc,due,contact,link});
  if(!db.hoa.some(x=>x.id===h.id)) db.hoa.push(h);
  saveLocal(); renderHOA();
}

/* Budget */
function renderBudget(){
  const tb=$('#bdg'); tb.innerHTML=''; let P=0,A=0;
  db.budget.forEach(b=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${esc(b.item||'')}</td><td>${esc(b.cat||'')}</td><td>${fmt(b.planned)}</td><td>${fmt(b.actual)}</td><td>${esc(b.notes||'')}</td><td class="right"><button class="btn ghost" data-e>Edit</button> <button class="btn danger" data-d>Delete</button></td>`;
    tr.querySelector('[data-e]').onclick=()=> editBudget(b.id);
    tr.querySelector('[data-d]').onclick=()=>{ db.budget=db.budget.filter(x=>x.id!==b.id); saveLocal(); renderBudget(); };
    tb.appendChild(tr); P+=Number(b.planned||0); A+=Number(b.actual||0);
  });
  $('#sumP').textContent=P.toFixed(2); $('#sumA').textContent=A.toFixed(2);
  $('#variance').textContent = 'Variance £'+(P-A).toFixed(2);
}
$('#add-budget').onclick=()=> editBudget(id());
function editBudget(bid){
  const b=db.budget.find(x=>x.id===bid)||{id:id()};
  const item=prompt('Item:',b.item||''); if(item===null) return;
  const cat =prompt('Category:',b.cat||'')||''; 
  const planned=parseFloat(prompt('Planned (£):',b.planned??'')||'0')||0;
  const actual =parseFloat(prompt('Actual (£):',b.actual??'')||'0')||0;
  const notes =prompt('Notes:',b.notes||'')||'';
  Object.assign(b,{item,cat,planned,actual,notes});
  if(!db.budget.some(x=>x.id===b.id)) db.budget.push(b);
  saveLocal(); renderBudget();
}

/* Wins */
function renderWins(){ const list=$('#wins'); list.innerHTML=''; db.wins.slice().reverse().forEach(w=>{ const div=document.createElement('div'); div.className='card'; div.textContent=`${w.text} — ${new Date(w.date).toLocaleString()}`; list.appendChild(div); }); }
$('#add-win').onclick=()=>{ const v=$('#wintext').value.trim(); if(!v) return; db.wins.push({id:id(), text:v, date:Date.now()}); $('#wintext').value=''; saveLocal(); renderWins(); };

/* Toolbar filters */
$('#q').oninput=renderBoard; $('#f-room').onchange=renderBoard; $('#f-prio').onchange=renderBoard;

/* Seed & export */
$('#seed').onclick=()=>{ if(!confirm('Replace current data with samples?')) return; db=blank(); db.tasks=[{id:id(),title:'Submit HOA form',room:'Hallway',priority:'High',due:future(7),status:'Doing',notes:'Attach plan + insurance'},{id:id(),title:'Choose kitchen tiles',room:'Kitchen',priority:'Medium',due:future(12),status:'Backlog',notes:'Shortlist 3 options'},{id:id(),title:'Paint bedroom',room:'Bedroom',priority:'Low',status:'Doing',notes:'Sage green'},{id:id(),title:'Order sofa',room:'Living Room',priority:'Low',status:'Done'}]; db.contractors=[{id:id(),name:'Northside Electrics',trade:'Electrician',phone:'0123 123 999',notes:'Ask for Saturday slot',rating:4}]; db.hoa=[{id:id(),title:'Noise variance',desc:'Quiet hours plan',due:future(5),contact:'Jamie @ HOA',link:'',done:false}]; db.budget=[{id:id(),item:'Bathroom tile',cat:'Bathroom',planned:800,actual:920,notes:'Over by £120'}]; db.wins=[{id:id(),text:'Booked GC walkthrough',date:Date.now()}]; saveLocal(); renderAll(); };
$('#export').onclick=()=>{ const blob=new Blob([localStorage.getItem(KEY)||'{}'], {type:'application/json'}); dl(blob,'renoboard.enc.json'); };
$('#export-plain').onclick=()=>{ const blob=new Blob([JSON.stringify(db,null,2)], {type:'application/json'}); dl(blob,'renoboard.json'); };
function dl(blob, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000); }
function future(d){ const t=new Date(Date.now()+d*86400000); return t.toISOString().slice(0,10); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* Settings */
$('#gist-create').onclick=gistCreate;
$('#gist-load').onclick=async ()=>{ await gistLoad(); alert('Gist downloaded. Lock and re-enter your passphrase to decrypt, or just hit Enter now.'); };
$('#gist-save').onclick=gistSave;
$('#change-pass').onclick=async ()=>{
  const np = prompt('New passphrase:',''); if(!np) return;
  PASS = np; saveLocal(); alert('Passphrase updated for this device (re-encrypted locally). Don’t forget it!');
};
$('#lock').onclick=()=>{ PASS=''; showLogin(true); };

/* Render all views */
function renderAll(){ renderBoard(); renderContractors(); renderHOA(); renderBudget(); renderWins(); }
</script>
</body>
</html>
